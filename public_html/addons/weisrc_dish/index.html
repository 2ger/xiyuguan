<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>收银台</title>
<meta name="format-detection" content="telephone=no, address=no">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-touch-fullscreen" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link href="./resource/css/bootstrap.min.css" rel="stylesheet">
<link href="./resource/css/font-awesome.min.css" rel="stylesheet">
<link href="./resource/css/animate.css" rel="stylesheet">
<link href="./resource/css/common.css" rel="stylesheet">
<script src="{MODULE_URL}template/js/jquery-2.1.1.min.js"></script>
<script src="{MODULE_URL}template/js/sweetalert.min.js"></script>
<link type="text/css" rel="stylesheet" href="{MODULE_URL}template/js/sweetalert.css"/>
</head>
<body>
{if $operation=='display'}
<style>
html{ height:100%;}
body{height:100%; overflow:hidden; background:url({php echo tomedia($cfg['bg'])}); background-size:100% 100%;}
.login_body{ display:table; width:80%; margin:0 auto; max-width:300px;height:100%;}
.row{ display:table-row;}
.cell{ display:table-cell; width:100%;vertical-align:middle; text-align:center}
.logo{border-radius:50%;width:80px;margin:10px auto}
.form-control{ margin-bottom:10px;}
</style>
<!--登录-->
<div class="login_body">
    <div class="row">
        <div class="cell">
            <img src="{php echo tomedia($cfg['logo'])}" class="logo" alt="">
            <form  onSubmit="return false;">
                <div class="input-group" style="margin-bottom:10px;"> <span class="input-group-addon" ><i class="fa fa-user" style="width:40px"></i></span>
                    <input type="text" name="userid" class="form-control" placeholder="用户名" required autofocus autocomplete="off" style="cursor:auto;">
                </div>
                <div class="input-group" style="margin-bottom:10px;"> <span class="input-group-addon" ><i class="fa fa-key" style="width:40px"></i></span>
                    <input type="password" name="pwd" class="form-control" placeholder="密码" required autocomplete="off">
                </div>
                <button class="btn btn-warning btn-block" type="submit" onClick="return checkUpdate();return false;"><i class="fa fa-sign-in"></i> 登录</button>
            </form>
        </div>
    </div>
</div>
<script language="javascript">
$(document).ready(function(e) {
    var _h=$(document).height();
    $(".cell").height(_h*0.8);
});
function checkUpdate(){
    var userid=$("input[name='userid']").val();
    var pwd=$("input[name='pwd']").val();
    if(userid.length<1){
        swal("用户名不能为空");
        return false;
    }
    if(pwd.length<6){
        swal("密码长度不正确");
        return false;
    }
    $.ajax({ 
        url: "{php echo $this->createMobileUrl('ajax',array('op'=>'login'))}",
        type: "POST",
        data: {"userid":userid,"pwd":pwd},
        dataType:'json', 
        success: function(data){
            if(data.success){
                location.href="{php echo $this->createMobileUrl('index',array('op'=>'in'))}";
            }else if(data.success2){
                location.href="/app/index.php?i={$_W['uniacid']}&c=entry&do=login&m=weisrc_dish&logid="+userid;
                // }else if(data.success3){
                //   location.href="http://shanghai.xyj0772.com/app/index.php?i={$_W['uniacid']}&c=entry&do=login&m=weisrc_dish&logid=4";
            }else{
                swal(data.msg);
            }
        },
        error:function(event,request,settings){
            alert("error");
        }
    })
    return false;
}
</script>
{else} 
<!--登录成功-->
<style>
.jrow{ display:table-row;}
.jcell{ display:table-cell}
.valignM{ vertical-align:middle;}
.main_top{height:50px; background:#18BB9C; display:table; width:100%;}
.top_logo{width:180px; text-indent:30px; background:#1F232C; line-height:40px; padding:5px;}
.top_menu{line-height:50px;text-align:right; padding:0 30px 0 0;color:#FFF;}
.top_menu a{color:#FFF; display:inline-block; text-decoration:none; line-height:50px; padding:0 10px}
.top_menu a:hover{ background:#FFF; color:#18BB9C}
.main_body{display:table;width:100%;}
.body_left{width:180px;vertical-align:top;color:#FFF;background:#2F3541;}
.body_left_userinfobox{ background:#2F3541; padding:5px;}
.body_left_menu{ background:#2F3541;}
.body_left_menu ul,.body_left_menu ul li{ list-style:none; margin:0; padding:0;}
.body_left_menu ul li{padding:10px; line-height:24px; cursor:pointer;}
.body_left_menu ul li:hover{ background:#18BB9C}
.body_left_menu ul li.jlabel{background:#18BB9C}
.body_left_menu ul li span{ float:right;}
.body_left_menu ul li b{ margin-right:10px;}
.body_right{vertical-align:top;padding:20px;}
.body_right_meneybox{ text-align:center;}
.body_right_meneybox h2{ border-top-left-radius:4px;border-top-right-radius:4px;color:#FFF; font-size:40px; line-height:70px; margin:0}
.body_right_moneybox_btm{border-bottom-left-radius:4px;border-bottom-right-radius:4px;background:#FFF;border:1px solid #CCC;border-top:none;color:#999; padding:10px 0;}
.body_right_moneybox_btm .col-md-6:first-child{ border-right:1px solid #CCC;}
.body_right_moneybox_btm span{ font-size:22px; color:#666; display:block}
.body_right_main{ margin-top:20px;}
.bg_yellow{background:#F5AB35}
.bg_green{background:#2ECC71}
.bg_red{background:#F22613}
.bg_blue{background:#3498DB}
.bg_black{background:#2F3541}
.color_grade{color:#999}
.btn_sumitcss{line-height:40px; font-size:20px;}
#j_counter_btn input[type='button']{line-height:40px; font-size:20px;}
#j_counter_btn .row{ margin-bottom:15px;}
#j_counter_btn .row:last-child{margin-bottom:0;}
.extend_box{position:absolute; background:rgba(0,0,0,0.6); left:0; top:0; right:0; bottom:0; display:none; z-index:2}
.extend_innerbox{ width:80%; margin:0 auto; padding-top:120px; max-width:700px;}
</style>
<div class="main_top">
    <div class="jrow">
        <div class="jcell top_logo" style="width:80px">&nbsp;</div>
        <div class="jcell top_menu">
            <span class="pull-left">&nbsp;&nbsp;&nbsp;&nbsp;<img src="{php echo tomedia($cfg['logo'])}" style="max-height:40px; max-width:136px;" onerror="this.style.display='none'"/></span>
            <img src="{MODULE_URL}template/img/head.jpg"  style="max-height:40px;" class="img-circle img-thumbnail"/>
            {$user['realname']}
            <span class="label label-info">{$group}</span>
            <a href="javascript:logout()"><i class="fa fa-sign-out"></i> 退出</a></div>
    </div>
</div>
<!---->
<div class="main_body">
    <div class="jrow">
        <div class="jcell body_left" style="width:80px">
            <div class="body_left_userinfobox">

            </div>
            <div class="body_left_menu">
                <ul>
                    <li class="jlabel"  onclick="c(1);">餐桌管理</li>
                    <li onClick="extendFun(1);" class="{$ischeng}"> 交班记录</li>
                    <li onClick="extendFun(2);" class="{$ischeng}"> 收款记录</li>
                    <!-- 添加排号管理、预定管理 -->
                    <li onClick="extendFun(3);" class="{$ischeng}"> 排号管理</li>
                    <li onClick="extendFun(4);" class="{$ischeng}"> 预订管理</li>
                    {if count($btnlist)}
                    <!-- <li class="jlabel">扩展</li> -->
                    {loop $btnlist $row}
                    <li onClick="{$row['btnurl']}">{$row['btnname']}</li>
                    {/loop}
                    {/if}
                </ul>
            </div>
        </div>
        <div class="jcell body_right" id="a0">
            <div class="{$ischeng} body_right_menu row">
                <div class="col-sm-2">
                    <div class="body_right_meneybox">
                        <h2 class="bg_green"><img src="{MODULE_URL}template/img/wechart.gif" height="50"/></h2>
                        <div class="body_right_moneybox_btm row">
                            <div class="col-md-12"><span>￥{$weixin}</span>微信</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="body_right_meneybox">
                        <h2 class="bg_blue"><img src="{MODULE_URL}template/img/alipay.gif" height="50"/></h2>
                        <div class="body_right_moneybox_btm row">
                            <div class="col-md-12"><span>￥{$zfb}</span>支付宝</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="body_right_meneybox">
                        <h2 class="bg_yellow"><img src="{MODULE_URL}template/img/card.png" height="50"/></h2>
                        <div class="body_right_moneybox_btm row">
                            <div class="col-md-12"><span>￥{$meituan}</span>美团</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="body_right_meneybox">
                        <h2 class="bg_green"><img src="{MODULE_URL}template/img/cash.png" height="50"/></h2>
                        <div class="body_right_moneybox_btm row">
                            <div class="col-md-12"><span>￥{$xianjin}</span>现金</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="body_right_meneybox">
                        <h2 class="bg_blue"><img src="{MODULE_URL}template/img/shuka.png" height="50"/></h2>
                        <div class="body_right_moneybox_btm row">
                            <div class="col-md-12"><span>￥{$shuaka}</span>刷卡</div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-2">
                    <div class="body_right_meneybox">
                        <h2 class="bg_red"><img src="{MODULE_URL}template/img/money.png" height="50"/></h2>
                        <div class="body_right_moneybox_btm row">
                            <div class="col-md-12"><span>￥{$today}</span>今日营业额</div>
                        </div>
                    </div>
                </div>
            </div>
            <!---->
            <div class="body_right_main row">
                <div class="body_right_main_left {if $ischeng!=""}col-md-12{else}col-md-6{/if} ">
                    
<div class="panel panel-info">
<div class="panel-heading">称鱼 /  特殊菜</div>
<div class="panel-body table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>名称</th>
                    <th>单价/斤</th>
                    <th>重量</th>
                    <th>口味</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
    <form method="post" action="" name="form2">
            <tr>
                <td scope="row">活杀黑鱼</td>
                <td>
                    <div class="input-group">
                        <input class="form-control" size="2" name="oneprice" type="text" placeholder="" value="42">
                        <div class="input-group-addon">/元</div>
                    </div>
                </td>
                <td>
                    <div class="input-group">
                        <input class="form-control" name="weight" size="2" type="text" placeholder="输入重量" value="1">
                        <div class="input-group-addon">斤</div>
                    </div>
                </td>
                <td>
                    <select name="flavor" class="form-control">
                        <option value="微辣">微辣</option>
                        <option value="中辣">中辣</option>
                        <option value="重辣">重辣</option>
                    </select>
                </td>
                <td>
                    <input type="hidden" name="tablesid" value="{$tablesid}" />
                    <input type="submit" class="btn btn-danger btn-large" name="fishclik" value="提交" />
                </td>
            </tr>
    </form>
    <form method="post" action="" name="form2">
        <tr>
            <td scope="row">特殊菜</td>
            <td>
                <div class="input-group">
                    <input class="form-control" size="2" name="oneprice1" type="text" placeholder="请输入价格" value="1">
                    <div class="input-group-addon">/元</div>
                </div>
            </td>
            <td>
                <div class="input-group">
                    <input class="form-control" name="weight1" size="2" type="number" placeholder="输入份数" value="1">
                    <div class="input-group-addon">份</div>
                </div>
            </td>
            <td>
                <select name="flavor1" class="form-control">
                    <option value="微辣">微辣</option>
                    <option value="中辣">中辣</option>
                    <option value="重辣">重辣</option>
                </select>
            </td>
            <td>
                <input type="hidden" name="tablesid" value="{$tablesid}" />
                <input type="submit" class="btn btn-danger btn-large" name="specialclik" value="提交" />
            </td>
        </tr>
    </form>
    <form method="post" action="" name="form3">
            <tr>
                <td scope="row">
                <select id="addclick" name="goodsid" onchange="price2()">
                    <option value="0">加菜/送菜</option>
                                {loop $all_goods $item}
                    <option value="{$item['id']}" price="{$item['marketprice']}">{$item['title']} </option>
                                {/loop}
                </select>
                <script>
                
function price2(){//设置价格
    var price =$("#addclick option:selected");  //获取选中的项
    $('#oneprice2').val(price.attr('price'));
}
                </script>
                </td>
                <td colspan="2">
                    <div class="input-group">
                        <input class="form-control" size="2" name="oneprice2" id="oneprice2" type="text" placeholder="请输入价格" value="1">
                        <div class="input-group-addon">/元</div>
                    </div>
                </td>
                <td>
                    <div class="input-group">
                        <input class="form-control" name="weight1" size="2" type="number" placeholder="输入份数" value="1">
                        <div class="input-group-addon">份</div>
                    </div>
                </td>
                <td>
                    <input type="hidden" name="tablesid" value="{$tablesid}" />
                    <input type="submit" class="btn btn-danger btn-large" name="addclick" value="提交" />
                </td>
            </tr>
    </form>

            </tbody> 
        </table>
</div>
</div>

<div class="panel panel-info">
    <div class="panel-heading">{$tableinfo['zone']}--{$tableinfo['id']} 号桌菜单列表 {$orderid}
                    
                       
                        {if $orderid['id']!=""}
                       <a class="btn btn-sm btn-info pull-right" style="margin-top:-5px;" href="{php echo $this->createMobileUrl('print', array('orderid' => $orderid,'tablesid' => $tablesid))}" target="_blank">打印菜单</a> 
                        <a class="btn btn-sm btn-danger pull-right" style="margin-top:-5px; margin-right:5px;" href="{php echo $this->createMobileUrl('cancelorder', array('orderid' => $orderid))}">取消订单</a>
                        <a class="btn btn-sm btn-success pull-right" style="margin-top:-5px; margin-right:5px;" href="{php echo $this->createMobileUrl('confirmorder', array('orderid' => $orderid))}">确认订单</a>
                        {/if}

                        </div>
                        <div class="panel-body table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>名称</th>
                                        <th>数量</th>
                                        <th>单价</th>
                                        <th>总价</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>

                                <tbody>
                                {php $i=1;}
                                {loop $order_goods $item}
                                <tr>
                                    <th scope="row">{php echo $i}</th>
                                    <th>{$item['title']}{$item['flavor']}
                                        <span class="text-success" id="goodsid{$item['goodsid']}">
                                            {if $item['type']==1}送{else if $item['type']==2}退{/if}
                                    </span></th>
                                    <td> {$item['total']}</td>
                                    <td>{$item['price']}</td>
                                    <td>{php echo round($item['ttprice'],2);}</td>
                                    <td>
                                       <a class="btn btn-success song" orderid="{$item['orderid']}" goodsid="{$item['goodsid']}"  price="{php echo round($item['ttprice'],2);}">送</a>
                                       <a class="btn btn-danger tui" orderid="{$item['orderid']}" goodsid="{$item['goodsid']}" >退</a>
                                        </td>
                                </tr>
                                {php $i++}
                                {/loop}
                                <script>
$('.tui').click(function(){
    var zhekou = parseInt($('#zhekou').text());
    var fee = parseInt($('#fee').text());
    var orderid = $(this).attr('orderid');
    var goodsid = $(this).attr('goodsid');
    var price = parseInt($(this).attr('price'));
    var allzhekou =zhekou+price;
    var divid ="divid"+goodsid;
    swal({   title: " 确定要退菜吗",  
         type: "error", 
         confirmButtonText: "确定",
         cancelButtonText: "取消",
         showCancelButton: true,   closeOnConfirm: false,   
         showLoaderOnConfirm: true, }, function(){  
             //post 操作  
             $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'tui'))}",{"orderid":orderid,"goodsid":goodsid,"price":price},function(data){
                 console.log(data);
                  var feedback=eval("("+data+")");
                 $("#fee").val(feedback.totalprice);
                 $("#ys").text(feedback.totalprice);
                 $('#zhekou').text(allzhekou);
                 $('#'+divid).text('退');
                 swal({   title: "操作成功", type:'success',  timer: 1000,   showConfirmButton: false });
             });
         });
}) 
$('.song').click(function(){
    var zhekou = parseInt($('#zhekou').text());
    var fee = parseInt($('#fee').text());
    var orderid = $(this).attr('orderid');
    var goodsid = $(this).attr('goodsid');
    var price = parseInt($(this).attr('price'));
    var allzhekou =zhekou+price;
    var divid ="divid"+goodsid;
    swal({   title: " 确定要送菜吗",  
         type: "success", 
         confirmButtonText: "确定",
         cancelButtonText: "取消",
         showCancelButton: true,   closeOnConfirm: false,   
         showLoaderOnConfirm: true, }, function(){  
             //post 操作  
             $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'song'))}",{"orderid":orderid,"goodsid":goodsid,"price":price},function(data){
                 console.log(data);
                  var feedback=eval("("+data+")");
                 $("#fee").val(feedback.totalprice);
                 $("#ys").text(feedback.totalprice);
                 $('#zhekou').text(allzhekou);
                 $('#'+divid).text('送');
                 swal({   title: "操作成功", type:'success',  timer: 1000,   showConfirmButton: false });
             });
         });
}) 
                                </script>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>总金额</td>
                                    <td>{$xiaofei['total1']} 元</td>
                                    <td></td>
                                </tr>  </tbody>

                            </table>
                        </div>
                    </div>

                    <div class="panel panel-success hidden">
                        <div class="panel-heading">消费记录(最近10条记录)</div>
                        <div class="panel-body table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>消费方式</th>
                                        <th>金额</th>
                                        <th>优惠金额</th>
                                        <th>实际支付</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="j_getrecord">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    


                </div>
                <div class="{$ischeng}  col-md-6">
                    <div class="panel panel-success">
                        <div class="panel-heading">优惠活动</div>
                        <div class="panel-body table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>名称</th>
                                        <th>营销对象</th>
                                        <th>优惠</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>代金券</td>
                                    <td>
                                    <select class="form-control" id="daijin" name="daijin">
                                        {loop $daijin $row}
                                        <option value="{$row['daijin']}">{$row['title']}</option>
                                        {/loop}
                                    </select>
                                    
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input class="form-control" id="daijinnum" size="1" type="number" placeholder="输入数量" value="1">
                                            <div class="input-group-addon">张</div>
                                        </div>
                                    </td>
                                    <td>
                                  <a class="btn btn-success" id="daijinbtn" href="#">使用</a>
                                    </td>
                                </tr>
                                <script>
//代金券功能
$('#daijinbtn').click(function(){
 var jine = parseInt($('#daijin option:selected').val());//金额
 var num = parseInt($('#daijinnum').val());//数量
 var all = parseInt(jine*num);
 // var kdz = parseInt($('#kdz').text());
 var kdz = parseInt($('#kdz').text())-parseInt($('#mj').text())-parseInt($('#mian').text())-parseInt($('#dz').text());//可打折2016.10.28
 var bkdz = parseInt($('#bkdz').text());
 var daijinquan = parseInt($('#daijinquan').text());
 var manjian = parseInt($('#mj').text());
 var ys = kdz-all+bkdz;// 应收 = 可打折 - 满减 - （this）+ 不可打折
 var jiae = kdz-all+bkdz;// 应收 = 可打折 - x(不应)满减 - （this）+ 不可打折
  //alert(kdz+'--'+manjian+' -- 代金'+all+' +不可'+bkdz);
 if(ys < bkdz){
     swal({   title: "金额不足", type:'error',  text: "无法使用",   timer: 1000,   showConfirmButton: false });
 }else{
     // $('#kdz').text(kdz-all);// 多次使用不同面额代金券2016.10.28注释
     $('#daijinquan').text(daijinquan+all);
     swal({   title: "使用成功", type:'success',  text: "使用了"+num+"张"+jine+"的代金券！",   timer: 1000,   showConfirmButton: false });
     $('#ds').text(ys);
     $('#ys').text(ys);
     var zhekou = parseInt($('#daijinquan').text())+parseInt($('#mj').text())+parseInt($('#mian').text());//总折总2016.10.28
     // var zhekou = parseInt($('#daijinquan').text())+parseInt($('#mj').text());// 总折总
     $('#zhekou').text(zhekou);
     $('#fee').val(ys);
 }
}) 
                                </script>
                                <tr>
                                    <td>2</td>
                                    <td>满减活动</td>
                                    <td colspan="2">
                                        {loop $manjian $row}
                                        <a class="btn btn-info manjian " man="{$row['title']}" jian="{$row['manjian']}" href="#">满{$row['title']}减{$row['manjian']}元</a>
                                        {/loop}
                                    </td>
                                    <td><a class="btn btn-warning  " onClick="checkMdan()" href="#">免单</a></td>
                                </tr>
                                    <script>
$('a.manjian').click(function(){
  var man = parseInt($(this).attr('man'));
  var jian = parseInt($(this).attr('jian'));

 var fee = parseInt($('#fee').val());
 //var kdz = parseInt($('#kdz').text());
 var daijinquan = parseInt($('#daijinquan').text());
 // var kdz=parseInt('<?php echo $kedazhe;?>'); // 可折金额
 var kdz = parseInt($('#kdz').text())-parseInt($('#daijinquan').text())-parseInt($('#mian').text())-parseInt($('#dz').text());//可打折2016.10.28
 var bkdz = parseInt($('#bkdz').text());
 // var isman = kdz-man-daijinquan;//是否符合条件
 var isman = kdz-man;//是否符合条件2016.10.28
  //alert(isman);
// var manjian = parseInt(kdz-daijinquan);//2016.10.28
var manjian = parseInt(kdz);
if(isman< 0){
     swal({   title: "金额不足", type:'error',  text: "无法使用",   timer: 1000,   showConfirmButton: false });
}else{
 var all = parseInt(parseInt(manjian/man)*jian);//计算可减金额
 var ys = manjian-all+bkdz;
     // $('#kdz').text(kdz-all-daijinquan);// 多次使用不同面额代金券
     $('#mj').text(all);
     var zhekou = parseInt($('#daijinquan').text())+parseInt($('#mj').text())+parseInt($('#mian').text())+parseInt($('#dz').text());//总折总2016.10.28
     // var zhekou = parseInt($('#daijinquan').text())+parseInt($('#mj').text());// 总折总
     $('#zhekou').text(zhekou);
     $('#ds').text(ys);
     $('#ys').text(ys);
     $('#fee').val(ys);
     swal({   title: "使用成功", type:'success',  text: "满"+man+"减"+jian+"元！",   timer: 1000,   showConfirmButton: false });
 }
}) 
                                    </script>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="panel panel-warning">
                        <div class="panel-heading">
                            <div class="input-group"> 
                                <span class="input-group-addon" id="sizing-addon2">￥</span>
                     <input type="text" name="fee" id="fee" value="{if $xiaofei['ys']!=''}{$xiaofei['ys']}{else}0{/if}" maxlength="8" class="form-control" style="line-height:60px; height:60px; font-size:40px; padding-top:10px; text-align:right" readonly/>
                                <span class="input-group-addon" id="sizing-addon2">元</span> </div>
                            <table class="table table-condensed">
                                <tr>
                                    <td>消费： 
                                        <span id="xf">{if $xiaofei["total0"]!=""}{$xiaofei["total0"]}{else}0.00{/if}</span> 元 </td>
                                    <td>总折扣： 
                                        <span id="zhekou">{if $xiaofei["song"]!=""}{$xiaofei["song"]}{else}0.00{/if}</span> 元  </td>
                                    <td>应收：
                                        <span id="ys">{if $xiaofei["ys"]!=""}{$xiaofei["ys"]}{else}0.00{/if}</span> 元  </td>
                                </tr>
                                <tr>
                                    <td>低消差：  
                                        <span id="dxc">{if $dixiao!=""}{$dixiao}{else}0.00{/if}</span> 元  </td>
                                    <td>不可打折： 
                                        <span id="bkdz">{if $buzhekou['price'] !=""}{$buzhekou['price']}{else}0.00{/if}</span> 元  </td>
                                    <td>可打折：  
                                        <span id="kdz">{if $kedazhe!=""}{$kedazhe}{else}0.00{/if}</span> 元  </td>
                                </tr>
                                <tr>
                                    <td>代金券： 
                                        <span id="daijinquan">0.00</span> 元  </td>
                                    <td>满减： 
                                        <span id="mj">0.00</span> 元  </td>
                                    <td>免单： 
                                        <span id="mian">0.00</span>元  </td>
                                </tr>

                                <tr class="danger">
                                    <td>活动打折： 
                                        <span id="dz">0.00</span> 元  </td>
                                    <td>待收： 
                                        <span id="ds">{$xiaofei["ys"]}</span>元  </td>
                                        <td></td>
                                </tr>
                            </table>
                        </div>
                        <div class="panel-body hidden" id="j_counter_btn">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="button" value="7" class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="8" class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="9" class="btn btn-info btn-block"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="button" value="4" class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="5" class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="6" class="btn btn-info btn-block"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="button" value="1" class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="2" class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="3" class="btn btn-info btn-block"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="button" value="0" class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="." class="btn btn-info btn-block"/>
                                </div>
                                <div class="col-md-4">
                                    <input type="button" value="清除" class="btn btn-block btn-danger"/>
                                </div>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-info {if $kedazhe<50}disabled{/if} btn-block btn_sumitcss" onClick="checkCard()"><i class=""></i> 活动打折</button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" id="paybtn" class="btn btn-success btn-block btn_sumitcss" onClick="payMobile()"><i class=""></i> 收款</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel panel-info hidden">
                        <div class="panel-heading">当前营销内容</div>
                        <div class="panel-body table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>名称</th>
                                        <th>营销对象</th>
                                        <th>优惠</th>
                                        <th>效果</th>
                                    </tr>
                                </thead>
                                <tbody>

                                {php $i=1;}
                                {loop $marketing $row}
                                <tr>
                                    <th scope="row">{php echo $i}</th>
                                    <th>{$row['title']}</th>
                                    <td> {if $row['num']}
                                        {if $row['isallnum']}
                                        <b style="color:#F00">{$row['num']}</b>名
                                        {else}
                                        每天前<b style="color:#F00">{$row['num']}</b>名
                                        {/if}
                                        {/if}
                                        {if $row['condition']==1}
                                        所有人
                                        {elseif $row['condition']==2}
                                        $grouplist= @pdo_fetchall("SELECT title FROM ".tablename("mc_groups")." WHERE groupid in(".$row['condition_member'].") ORDER BY `orderlist` asc");
                                        {loop $grouplist $row}
                                        {$row['title']},
                                        {/loop}
                                        {elseif $row['condition']==3}
                                        首次使用微支付
                                        {elseif $row['condition']==4}
                                        首次关注公众号
                                        {elseif $row['condition']==5}
                                        关注公众号时长{$row['condition_attendtime']}天
                                        {/if} </td>
                                    <td>{$row['description']}</td>
                                    <td>{php echo pdo_fetchcolumn("SELECT count(*) FROM ".tablename('j_money_trade')." WHERE marketing=:a and status=1 and createdate=:b ",array(':a'=>$row['id'],':b'=>date('Y-m-d')))}/{php echo pdo_fetchcolumn("SELECT count(*) FROM ".tablename('j_money_trade')." WHERE marketing=:a and status=1  ",array(':a'=>$row['id']))}</td>
                                </tr>
                                {php $i++}
                                {/loop}
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div  id="a1" style="display:none">

            <link rel="stylesheet" type="text/css" href="http://shanghai.xyj0772.com/addons/weisrc_dish/template/css/main.css"/>
            <style>
.table-state-tables .state-table .round.idle {
    background-color: #5cb85c;
}
            </style>
            <div class="main">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="queue-setting-index-body">
                            <div class="table-state-tables">
                                <div class="col-xs-12">
                                    {loop $list $item}
                                    {if $item['status']==0}
                                    {php $status = 'idle';}
                                    {php $title = '空闲';}
                                    {elseif $item['status']==1}
                                    {php $status = 'opened';}

                                    {if $item['totalprice']['totalprice']>0}
                                    {php $title = '已开台';}
                                    {else}
                                    {php $status = 'ordered';}
                                    {php $title = '有订单';}
                                    {/if}

                                    {elseif $item['status']==2}
                                    {php $status = 'ordered';}
                                    {php $title = '已下单';}
                                    {elseif $item['status']==3}
                                    {php $status = 'paid';}
                                    {php $title = '已支付';}
                                    {/if}
                                    <div class="state-table" data-id="{$item['id']}">
                                        <a class="{$status} round" href="index.php?i={$_W['uniacid']}&c=entry&op=in&do=index&m=j_money&tablesid={$item['id']}" data-remote="" title="点击查看订单详情" target="_top">
                                            <div class="state">{$title}</div>
                                        </a>
                                        <div class="name overflow-ellipsis">
                                            <span>{$item['type']['title']}--{$item['title']}</span>
                                            <div style="height: 60px;line-height:28px">
                                                {if $item['status']>=1}
                                    {if $item['totalprice']['totalprice']>0}
                                                {$item['totalprice']['totalprice']}元
                                    {else}
                                              <div class="text-danger">有未确认订单 </div> 
                                    {/if}
                                                <form action="index.php?i={$_W['uniacid']}&c=entry&op=changetable&do=index&m=j_money&tablesid={$item['id']}&status={$item['status']}" method="post" name="form1">
                                                    <span style="color: green;">转至</span>
                                                    <select id="change" name="change" onchange="$(this.form).submit();"">
                                                        {loop $list $row}
                                                        {if $row['status']==0}
                                                        <option value="{$row['id']}" >{$row['title']}</option>
                                                        {/if}
                                                        {/loop}
                                                    </select>
                                                </form>
                                                {else}
                                                <a class="btn btn-success" href="index.php?i={$_W['uniacid']}&c=entry&op=in&do=index&m=j_money&tablesid={$item['id']}">点击开台</a>
                                                {/if}</div>
                                        </div>
                                    </div>
                                    {/loop}
                                </div>
                                <div class="col-xs-4">
                                    <div class="table-order"></div>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <iframe src="" id="printbox" name="printbox" style="width:1px; height:1px;"></iframe>
    </div>
</div>
<div class="extend_box" id="extend_box">
    <div class="extend_innerbox">
        <div class="panel panel-default">
            <div class="panel-heading"> <span class="pull-right"><a href="javascript:extendFun(0);"><i class="fa fa-times"></i></a></span><b>组别管理</b> </div>
            <div class="panel-body table-responsive" style="max-height:500px; overflow-y:scroll"> </div>
            <div class="panel-footer" style="text-align:center;"> </div>
        </div>
    </div>
</div>
<textarea id="debug" style="display:none;"></textarea>
<input type="hidden" id="tradeno"/>
<script type="text/javascript">
var keyCodeAry1=[96,97,98,99,100,101,102,103,104,105,110];
var keyCodeAry2=["0","1","2","3","4","5","6","7","8","9","."];
var keyCodeAry=[];
var old_orderid='';
var isPaying=false;
var printDoc=parseInt("{$printDoc}");
var needtable=parseInt("{php echo $cfg['needtable']}");
var printDoc2=parseInt("{$printDoc2}");
for(i=0;i<keyCodeAry1.length;i++){
    keyCodeAry[keyCodeAry1[i]]=keyCodeAry2[i];
}
var checkTimeout;
$(document).ready(function(e){
    if($(document).width()<1100){
        //location.href='{php echo $this->createMobileUrl(index,array("small"=>1,"op"=>"login"))}';
    }
    var _dh=$(document).height()>=$(window).height() ? $(document).height():$(window).height();
    var _wh=$(window).height();
    _h=_wh>=_dh ? _wh :_dh;
    $(".body_left").css('height',(_h-50)+"px");
    $("#tableslist").css('height',(_h-50)+"px");
    getCounterRecord();
});
function logout(){
    if(confirm("确认退出登录？")){
        location.href="{php echo $this->createMobileUrl('index')}";
    }
}
//---计算器---//
$(document).keydown(function (event) {
    //alert(event.keyCode);
//    switch(event.keyCode){
//        case 96 : case 97 : case 98 : case 99 : case 100 : case 101 : case 102 : case 103 : case 104 : case 105 : case 110 :
//            if(isPaying)return;
//        Counter(keyCodeAry[event.keyCode]);
//        //$("#paybtn").focus();
//        break;
//        case 81://q
//            case 109://-
//            if(isPaying==false){
//            checkCard();
//        }
//        break;
//        case 111://0
//            refundorder();
//        break;
//
//        case 27://0
//            $("#fee").val(0);
//        break;
//    }
});
//显示餐桌
function c(){
    console.log('显示餐桌 ');
    $("#a0").css("display","none");
    $("#a1").css("display","block");
} 
function Counter(obj){
    var vTecla=obj;
    var salida=$("#fee");
    if(salida.val().length>8 && vTecla!='清除'){
        return false;	
    }
    if(vTecla=='.'){
        if(salida.val().indexOf('.')>-1){
            salida.val(salida.val());
        }else{
            salida.val(salida.val()+vTecla);
        }
    }else if(vTecla=='清除'){
        salida.val(0);
    }else if(vTecla=='0'){
        if(salida.val()==0 && salida.val().length==1){
            salida.val(0);
        }else{
            salida.val(salida.val()+vTecla);
        }
    }else{
        if((salida.val()==0 && salida.val().length==1)){
            salida.val(vTecla);
        }else{
            salida.val(salida.val()+vTecla);
        } 
    }
    var temp=salida.val();
    if(temp.indexOf('.')>-1){
        var float=temp.split('.');
        if(float[1].length>2){
            salida.val(float[0]+'.'+float[1].substr(0,2));
        }
    }
}
$("#j_counter_btn input").on('click',function(){
 //   var vTecla=$(this).val();
 //   Counter(vTecla);
});

//手动输入金额免单2016.10.27
function checkMdan(){
    var temp=parseFloat($("#fee").val());
    var xf=parseFloat($("#xf").html());
    if(temp*100==0){
        if(xf*100==0){
             swal("请输入金额");
           return; 
        }     
    }
    var btns = '';
        swal({// 用户手动输入免单金额   16.10.27  
            title: "免单",   
            text: "收款金额为<span style='color:#F00'>￥"+temp+"元</span><br> "+btns,   
            type: "input",
            html:true,
            showLoaderOnConfirm: true,
            showCancelButton: true,   
            closeOnConfirm: false,
            confirmButtonText: "确认",
            cancelButtonText: "关闭",  
            inputPlaceholder: "请输入免单金额" 
        }, function(inputValue){
            if (inputValue === false) return false;      
            if (inputValue === "") {
                swal.showInputError("请输入免单金额");     
                return false
            }
            var mian=parseFloat(inputValue);//免单金额
            var zhekou=parseFloat($("#zhekou").html());
            var kdz=parseFloat($("#kdz").html());
            var bkdz=parseFloat($("#bkdz").html());
          if(mian > temp){
           swal({   title: "金额不足", type:'error',  timer: 1000,   showConfirmButton: false });
}else{
  var price = temp-mian;
  zhekou = zhekou+mian;
  $("#zhekou").html(zhekou);
  if(kdz-mian>0){
// $("#kdz").html(kdz-mian);
$("#kdz").html(kdz);//可打折2016.10.28
  }else{
$("#kdz").html('0.00');
$("#bkdz").html(price);
  }
            $("#fee").val(price);
            $("#mian").html(mian);
            $("#ds,#ys").html(price);
            swal({   title: "操作成功", type:'success',  timer: 1000,   showConfirmButton: false });

}
        });
}

function payMobile(){
    isPaying=false;
    var temp=parseFloat($("#fee").val());
    var xf=parseFloat($("#xf").html());
    if(temp*100==0){
        if(xf*100==0){
             swal("请输入金额");
           return; 
        }     
    }
    if(needtable){
        if(isPaying)return;
        isPaying=true;
        var tablenum='';
        swal({ 
            title: "请输入原订单号/台号", 
            type: "input",
            html:true,
            showLoaderOnConfirm: true,
            showCancelButton: true,   
            closeOnConfirm: false,
            confirmButtonText: "确认",
            cancelButtonText: "关闭",
            inputPlaceholder: "可扫描或者手动输入" 
        }, function(inputValue){
            if (inputValue === false) return false;      
            if (inputValue === "") {
                swal.showInputError("请输入原订单号/台号");     
                return false
            }
            tablenum=inputValue;
            swal({ 
                title: "客户买单",   
                text: "收款金额为<span style='color:#F00'>￥"+temp+"元</span>",   
                type: "input",
                html:true,
                showLoaderOnConfirm: true,
                showCancelButton: true,   
                closeOnConfirm: false,
                confirmButtonText: "确认收款",
                cancelButtonText: "关闭",  
                inputPlaceholder: "请扫描客户的付款二维码" 
            }, function(inputValue){
                if (inputValue === false) return false;      
                if (inputValue === "") {
                    swal.showInputError("请扫描客户的付款二维码");     
                    return false
                }
                swal({title:"请稍后",showConfirmButton:false });
                if(inputValue.substr(0,1)=="1"){
                    console.log("客户使用【微信】支付");
                    paywechat(inputValue,temp,tablenum);
                }else{
                    console.log("客户使用【支付宝】支付");
                    payali(inputValue,temp,tablenum);
                }
            });
        }
            );
    }else{
        var btns = '';
        btns += '<div class="btn-group">';
        btns += ' <a type="a" class="btn btn-success" onclick="paytype(0)">微信</a>';
        btns += '  <a type="a" class="btn btn-info" onclick="paytype(1)">支付宝</a>';
        btns += '  <a type="a" class="btn btn-warning" onclick="paytype(2)">美团</a>';
        btns += ' <a type="a" class="btn btn-success" onclick="paytype(3)">现金</a>';
        btns += ' <a type="a" class="btn btn-info" onclick="paytype(4)">刷卡</a>';
        btns += '     <br><br/><br/>   </div> ';
        swal({// 用户支付   16.9.14  
            title: "{$tableinfo['zone']}--{$tableinfo['id']} 客户买单",   
            text: "收款金额为<span style='color:#F00'>￥"+temp+"元</span>            <br>            收款方式 :<span id='paytype'></span> <br> "+btns,   
            type: "input",
            html:true,
            showLoaderOnConfirm: true,
            showCancelButton: true,   
            closeOnConfirm: false,
            confirmButtonText: "确认收款",
            cancelButtonText: "关闭",  
            inputPlaceholder: "请选择收银方式" 
        }, function(inputValue){
            if (inputValue === false) return false;      
            if (inputValue === "") {
                swal.showInputError("请选择收银方式");     
                return false
            }
            if(isPaying)return;
            isPaying=true;
            swal({title:"请稍后",showConfirmButton:false });
            //增加 莫 9.14 
            console.log("客户支付");
            ispay(inputValue,temp,'');//用户支付 9.14
        });
    }
}
function paytype(i){
    var str ="现金";
    var temp=parseFloat($("#fee").val());
    if(i==0){
        str ="微信支付";
    }if(i==1){
        str ="支付宝支付";
    }if(i==2){
        str ="美团支付";
        swal({   
            title: "美团收款",
            text: "实收金额：<input type=text id='payno' name='payno' value=''> 凭证单号：",
            type: "input",
            html:true,
            showCancelButton: true,
            closeOnConfirm: false,
            confirmButtonText: "确认收款",
            cancelButtonText: "关闭",  
            inputPlaceholder: "凭证号：" },
            function(inputValue){   
                if (inputValue === false) return false;
                if (inputValue === "") {     
                    swal.showInputError("请输入实收金额!");
                    return false   }  
                    var payno =  $('#payno').val();//取得凭证单号
                    ispay(2,inputValue,payno);//美团支付
            });
    }if(i==3){
        str ="现金支付";
    }if(i==4){
        str ="刷卡支付";
    }
    $("#paytype").html(str);
    $("#payno").val(temp);
    $("[tabindex='3']").val(i);//取得授权密码
}

//付款
function ispay(paytype,fee,tableno){
    if(paytype.length==0){
        swal("请选择收银方式！");
        return;
    }
    var zhekou = $('#zhekou').text();
//    alert(fee);
//    return false;
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'ispay'))}",{"paytype":paytype,"userid":"{$user['id']}","fee":fee,"zhekou":zhekou,"old_trade_no":tableno,"totalfee":"{$xiaofei['total0']}","orderid":"{$orderid}","tablesid":"{$tablesid}","discount":discount1},function(data){
        isPaying=false;
        var feedback=eval("("+data+")");
        checktime=0;
        console.log(feedback.success);
        if(feedback.success){
            var temp=feedback.items;
            $("#tradeno").val(temp['out_trade_no']);
            if(temp['result_code']=="SUCCESS"){
                paySuccess(temp['out_trade_no']);
            }else{
                if(temp['err_code']=="USERPAYING"){
                    setTimeout("checkpay()",5000);
                    swal({
                        title: "温馨提示",   
                        text: "等待客户输入支付密码",
                        confirmButtonText: "关闭订单",
                    }, function(isConfirm){
                        if (isConfirm) {
                            deleteOrder(temp['out_trade_no']);
                        }
                    }
                        );
                }
            }
        }else{
            swal(feedback.msg);
        }
    })
}
function paywechat(qrcode,fee,tableno){
    if(qrcode.length==0){
        swal("请先扫描");
        return;
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'paywechat'))}",{"qrcode":qrcode,"userid":"{$user['id']}","fee":fee,"old_trade_no":tableno},function(data){
        isPaying=false;
        //alert(data);
        //$("#debug").val(data);
        var feedback=eval("("+data+")");
        checktime=0;
        if(feedback.success){
            var temp=feedback.items;
            $("#tradeno").val(temp['out_trade_no']);
            if(temp['result_code']=="SUCCESS"){
                paySuccess(temp['out_trade_no']);
            }else{
                if(temp['err_code']=="USERPAYING"){
                    setTimeout("checkpay()",5000);
                    swal({
                        title: "温馨提示",   
                        text: "等待客户输入支付密码",
                        confirmButtonText: "关闭订单",
                    }, function(isConfirm){
                        if (isConfirm) {
                            deleteOrder(temp['out_trade_no']);
                        }
                    }
                        );
                }
            }
        }else{
            swal(feedback.msg);
        }
    })
}
function payali(qrcode,fee,tableno){
    if(qrcode.length==0){
        swal("请先扫描");
        return;
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'payalipay'))}",{"qrcode":qrcode,"userid":"{$user['id']}","fee":fee,"old_trade_no":tableno},function(data){
        isPaying=false;
        console.log(data);
        //alert(data);
        var feedback=eval("("+data+")");
        checktime=0;
        if(feedback.success){
            if(feedback.result){
                $("#tradeno").val(feedback.out_trade_no);
                checkTimeout=setTimeout("checkAlipay()",5000);
                swal({
                    title: "温馨提示",   
                    text: "等待客户输入支付密码",
                    confirmButtonText: "关闭订单",
                }, function(isConfirm){
                    if (isConfirm) {
                        clearTimeout(checkTimeout);
                        //deleteOrder(temp['out_trade_no']);
                    }
                }
                    );
            }else{
                var temp=feedback.items;
                $("#tradeno").val(temp['out_trade_no']);
                paySuccess(temp['out_trade_no']);
            }
        }else{
            swal(feedback.msg);
        }
    })
}
//支付成功；
function paySuccess(order){
    $("#tradeno").val('');
    $("#fee").val(0);
    var printNum=parseInt("{$cfg['printnum']}") ? parseInt("{$cfg['printnum']}") :0;
    if(printNum>1){
        swal({title:"收款成功"},
             function(){  window.location.href="index.php?i={$_W['uniacid']}&c=entry&op=in&do=index&m=j_money";}
            );

    }else{
        swal({title:"收款成功",timer:5000,},
             function(){  window.location.href="index.php?i={$_W['uniacid']}&c=entry&op=in&do=index&m=j_money";}
            );
    }
    //$("#micalc input[type='text']").val(0);
    if(printDoc && order && printNum){
        $("#printbox").attr("src","{php echo $this->createMobileUrl('printer',array('id'=>$printDoc))}&tradeid="+order);
        if(printNum>1){
            swal({
                title: "再打一张小票？",   
                showCancelButton: true,
                cancelButtonText: "取消",
                confirmButtonText: "打印",
            }, function(isConfirm){
                if (isConfirm) {
                    $("#printbox").attr("src","{php echo $this->createMobileUrl('printer',array('id'=>$printDoc))}&tradeid="+order);
                }
            }
                );
        }
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'marketing'))}",{"orderid":order},function(data){
        console.log(data);
        $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'tempmsg'))}",{"orderid":order},function(data2){
            console.log(data2);
        });
    });
    getCounterRecord();
}
function checkpay(){
    var temporder=$("#tradeno").val();
    if(!temporder){
        alert("订单号不能为空");
        return;
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'checwechatkpay'))}",{"orderid":temporder},function(data){
        var feedback=eval("("+data+")");
        //$("#debug").val(data);
        if(feedback.success){
            var temp=feedback.items;
            if(temp['trade_state']=="SUCCESS"){
                paySuccess(temporder);
            }else if(temp['trade_state']=="NOTPAY"){
                swal("用户自动取消支付");
            }else if(temp['trade_state']=="USERPAYING"){
                setTimeout("checkpay()",5000);
            }else{
                swal("支付失败，未知错误!");
            }
        }else{
            swal(feedback.msg);
        }
    });
}

function checkAlipay(orderid){
    var temporder=orderid ? orderid : $("#tradeno").val();
    if(!temporder){
        alert("订单号不能为空");
        return;
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'checkalipay'))}",{"orderid":temporder},function(data){
        console.log(data);
        //alert(data);
        var feedback=eval("("+data+")");
        checktime=0;
        if(feedback.success){
            if(feedback.result){
                $("#tradeno").val(feedback.out_trade_no);
                checkTimeout=setTimeout("checkAlipay()",5000);
                swal({
                    title: "温馨提示",   
                    text: "等待客户输入支付密码",
                    confirmButtonText: "关闭订单",
                }, function(isConfirm){
                    if (isConfirm) {
                        clearTimeout(checkTimeout);
                        //deleteOrder(temp['out_trade_no']);
                    }
                }
                    );
            }else{
                var temp=feedback.items;
                $("#tradeno").val(temp['out_trade_no']);
                paySuccess(temp['out_trade_no']);
            }
        }else{
            swal(feedback.msg);
        }
    });
}
/*
 * 调取收银员的收银记录
 */
function getCounterRecord(){
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'getcounterrecord'))}",{},function(data){
        console.log(data);
        //alert(data);
        var feedback=eval("("+data+")");
        var record=feedback.item;
        $("#wechat_cash span").text("￥"+feedback.cash_fee_w);
        $("#ali_cash span").text("￥"+feedback.cash_fee_a);
        $("#wechat_card span").text(feedback.num);
        $("#j_getrecord").empty();
        for(i in record){
            var i = record[i]['paytype'];
            var str ="";
            if(i==0){
                str ="微信";
            }if(i==1){
                str ="支付宝";
            }if(i==2){
                str ="美团支付";
            }if(i==3){
                str ="现金";
            }if(i==4){
                str ="刷卡";
            }

            var temp='<tr><td scope="row">'+record[i]['createtime']+'</td><td>'+str+'</td><td>'+record[i]['total_fee']+'</td><td>'+record[i]['coupon_fee']+'</td><td>'+record[i]['cash_fee']+'</td><td>';
            temp+=parseInt(record[i]['status']) ? '<span class="label label-success"><i class="fa fa-check"></i></span>' : '<span class="label label-danger"><i class="fa fa-exclamation-triangle"></i></span>';
            if(parseInt(record[i]['status'])){
                temp+=parseInt(record[i]['isprint']) ? '' : ' <a href="javascript:reprint(\''+record[i]["out_trade_no"]+'\')"><i class="fa fa-print"></i></a>';
            }
            temp+='</td></tr>';
            $("#j_getrecord").append(temp);
        }
    });
}
function reprint(orderid){
    var temp=0;
    if(arguments.length>1)temp=arguments[1];
    if(printDoc && orderid){
        $("#printbox").attr("src","{php echo $this->createMobileUrl('printer',array('id'=>$printDoc))}&tradeid="+orderid+"&ismodal="+temp);
    }
}
//退款
function refundorder(){
    isPaying=true;
    swal({   
        title: "退款申请",   
        text: "请扫描或者输入客户的退款码",   
        type: "input",
        html:true,
        showCancelButton: true,
        closeOnConfirm: false,
        confirmButtonText: "确认退款",
        cancelButtonText: "关闭",  
        inputPlaceholder: "请扫描或者输入客户的退款码" 
    }, function(inputValue){
        if (inputValue === false)return false;
        if (inputValue === "") {
            swal.showInputError("请扫描或者输入客户的退款码");     
            return false
        }
        swal({title:"等待主管审核退款",showConfirmButton:false});
        $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'refundorder'))}",{"orderid":inputValue},function(data){
            //$("#debug").val(data).show();
            if(data.success){
                setTimeout(function(){checkrefundorder(inputValue)},5000);
            }else{
                swal(data.msg);
            }
        },'json');
    }
        );
}

function checkrefundorder(orderid){
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'checkrefundorder'))}",{"orderid":orderid},function(data){
        var feedback=eval("("+data+")");
        if(feedback.success){
            if(feedback.status==1){
                swal("退款成功");
            }else{
                setTimeout(function(){checkrefundorder(orderid)},5000);
            }
        }else{
            swal(feedback.msg);
        }
    });
}

//卡券核销
function checkCard(){
	var kdz = $('#kdz').text()-$('#mian').text()-$('#daijinquan').text()-$('#mj').text();
	if(kdz<0){
    	swal("没有可打折金额");
        return; 
    }
    var cards = '';
    cards += '<div class="btn-group">';
    cards += ' <a type="a" class="btn btn-info" onclick="discount(10)">不打折</a>';
    {loop $discount $row}
    cards += ' <a type="a" class="btn btn-success" {if $row['jdiction']==1} onclick="discount({$row['discount']})"{else}onclick="discount({$row['discount']}{$row['jdiction']})"{/if}>{$row['discount']}折</a>';
    {/loop}
    // cards += '  <a type="a" class="btn btn-info" onclick="discount(7)">7折</a>';
    // cards += '        <a type="a" class="btn btn-warning" onclick="discount(6)">6折</a>';
    // cards += ' <a type="a" class="btn btn-success" onclick="discount(5)">5折</a>';
    // cards += ' <a type="a" class="btn btn-info" onclick="discount(4)">4折</a>';
    // cards += ' <a type="a" class="btn btn-danger" onclick="discount(0)">免单</a>';
    cards += '        </div> ';
    
    swal({   
        title: "活动打折",   
        text: "可打折金额："+kdz+"<br>折扣率：<span id='discount'></span><br>"+cards,   
        //text: "可打折金额：<?php echo $kedazhe;?><br>折扣率：<span id='discount'></span><br>"+cards,   
        type: "input",
        html:true,
        showLoaderOnConfirm: true,
        showCancelButton: false,   
        closeOnConfirm: false,
        confirmButtonText: "确认打折",
        cancelButtonText: "关闭",  
        inputPlaceholder: "请选择折扣率" 
    }, function(inputValue){
        if (inputValue === false) return false;      
        if (inputValue === "") {
            swal.showInputError("请选择折扣率");
            return false
        }
     swal({   title: "折成功!", type:'success',  timer: 1000,   showConfirmButton: false });
        swal(
            '折成功!',
            '打折成功.',
            'success'
        );
        // swal({title:"查询中",text: "计算折扣中",showConfirmButton: true});
        // $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'checkcard'))}",{"code":inputValue},function(data){
        // 	console.log(data);
        // 	var temp=eval("("+data+")");

        // 	if(temp.success){
        // 		//cardConsume(temp.item);
        // 		var coupon=temp.item;
        // 		swal({
        // 			title: "卡券核销",
        // 			text: "卡券类型:"+coupon['typestr']+"<br>优惠:"+coupon['msg']+"<br>是否使用此卡券?",
        // 			html:true,
        // 			showLoaderOnConfirm: true,
        // 			showCancelButton: true,   
        // 			closeOnConfirm: false,
        // 			confirmButtonText: "确认核销",
        // 			cancelButtonText: "关闭",
        // 			}, function(isConfirm){
        // 				if (isConfirm) {
        // 					$.post("{php echo $this->createMobileUrl('ajax',array('op'=>'cardcheck'))}",{"code":coupon['code']},function(data){
        // 						//$("#debug").val(data).show();
        // 						var temp=eval("("+data+")");
        // 						if(temp.success){
        // 							swal("核销成功");
        // 							if(printDoc2 && temp.item.id)$("#printbox").attr("src","{php echo $this->createMobileUrl('printer',array('id'=>$printDoc2,'cid'=>1))}&tradeid="+temp.item.id);
        // 						}else{
        // 							swal(temp.msg);
        // 						}
        // 					});
        // 				}
        // 		});
        // 	}else{
        // 		swal(temp.msg);
        // 	}
        // });
    });
}
// 打折功能
var discount1=1;
function discount(i){
    var daijinquan = parseInt($('#daijinquan').text());
    var manjian = parseInt($('#mj').text());
    var mian = parseInt($('#mian').text());//免单金额
    var kedazhe = parseInt($('#kdz').text());
    // var total=kedazhe-daijinquan-manjian; // 不可折上折
    var total=kedazhe-daijinquan-manjian-mian;//折扣金额2016.10.28
    //var total=parseFloat($('#fee').val());
    var buzekou = parseInt($('#bkdz').text());
    //alert(total);
    var str ="折扣率";
    

    if(i==10){
        str ="不打折";
    }
    {loop $discount $rows}
    if(i=={$rows['discount']}){//可打折
        str ="{$rows['title']}{$rows['discount']}折";
    }
    if(i=={$rows['discount']}{$rows['jdiction']}){ //授权
        str ="美团支付";
        swal({   
            title: "店长授权",
            text: "授权账号：<input type='text' id='owner' name='owner' value=''> 授权密码：",
            type: "input",
            html:true,
            showCancelButton: true,
            closeOnConfirm: false,
            confirmButtonText: "确认授权",
            cancelButtonText: "关闭"  
            // inputPlaceholder: "凭证号：" 
        },
        function(inputValue){   
                    var owner =  inputValue;//取得授权账号
                    var ownerpwd =  $("[tabindex='3']").val();//取得授权密码
                    // if (inputValue === false) return false;
                    if (inputValue === false) { //取消
        				 i =10;
                         if(buzekou>0){// 如果有不可打折的，先减掉，再打折
                                //total = ds-buzekou;
                                $("#fee").val((total*i/10+buzekou).toFixed(0));
                                $("#ds").html((total*i/10+buzekou).toFixed(0));
                                $("#ys").html((total*i/10+buzekou).toFixed(0));
                            }else{
                             $("#fee").val((total*i/10).toFixed(0));
                             $("#ds").html((total*i/10).toFixed(0)); 
                             $("#ys").html((total*i/10).toFixed(0)); 
                         }
                         // alert(total*i/10+buzekou);
                         $("#zhekou").html((total-(total*i/10)+daijinquan+manjian+mian).toFixed(0));
                         $("#dz").html(0.0);
        				return false
        			};  
                    if (owner !== "" && ownerpwd !="") {   

                    //判断 及 打折
                    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'souquan'))}",{"owner":owner,"ownerpwd":ownerpwd},function(data){
                     console.log(data);
                     var temp=eval("("+data+")");
                    if(temp.success){
                        swal("授权成功");
                    }else{
                       	 i =10;
                         if(buzekou>0){// 如果有不可打折的，先减掉，再打折
                                //total = ds-buzekou;
                                $("#fee").val((total*i/10+buzekou).toFixed(0));
                                $("#ds").html((total*i/10+buzekou).toFixed(0));
                                $("#ys").html((total*i/10+buzekou).toFixed(0));
                            }else{
                             $("#fee").val((total*i/10).toFixed(0));
                             $("#ds").html((total*i/10).toFixed(0)); 
                             $("#ys").html((total*i/10).toFixed(0)); 
                         }
                         // alert(total*i/10+buzekou);
                         $("#zhekou").html((total-(total*i/10)+daijinquan+manjian+mian).toFixed(0));
                         $("#dz").html(0.0);

                        swal("账号密码错误！");
                         return false;
                    }

        			
                });
                }else{
                    swal.showInputError("请输入授权账号!");
                    return false 
                }
                    //checkCard(3,inputValue,owner,ownerpwd);
                });
    }
    {/loop}

    if(buzekou>0){// 如果有不可打折的，先减掉，再打折
        //total = ds-buzekou;
        $("#fee").val((total*i/10+buzekou).toFixed(0));
        $("#ds").html((total*i/10+buzekou).toFixed(0));
        $("#ys").html((total*i/10+buzekou).toFixed(0));//应收10.28
    }else{
       $("#fee").val((total*i/10).toFixed(0));
       $("#ds").html((total*i/10).toFixed(0));
       $("#ys").html((total*i/10).toFixed(0));//应收10.28
    }

    $("#zhekou").html((total-(total*i/10)+daijinquan+manjian+mian).toFixed(0));
    $("#discount").html(str);
    $("#dz").html((total-(total*i/10)).toFixed(0));//活动折扣2016.10.28
    $("[tabindex='3']").val(i);
}
//卡券核销
function cardConsume(coupon){
    swal({   
        title: "卡券核销",
        text: "卡券类型:"+coupon['typestr']+"<br>优惠:"+coupon['msg']+"<br>是否使用此卡券?",
        html:true,
        showLoaderOnConfirm: true,
        showCancelButton: true,   
        closeOnConfirm: false,
        confirmButtonText: "确认核销",
        cancelButtonText: "关闭",
    }, function(isConfirm){
        if (isConfirm) {
            $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'cardcheck'))}",{"code":coupon['code']},function(data){
                //$("#debug").val(data).show();
                var temp=eval("("+data+")");
                if(temp.success){
                    swal("核销成功");
                    if(printDoc2 && temp.item.id)$("#printbox").attr("src","{php echo $this->createMobileUrl('printer',array('id'=>$printDoc2,'cid'=>1))}&tradeid="+temp.item.id);
                }else{
                    swal(temp.msg);
                }
            });
        }
    });
}

function extendFun(obj){
    if(obj==0){
        $('#extend_box').hide();
        isPaying=false;
        return;
    }
    isPaying=true;
    var _h=$(document).height();
    var _w=$(window).width();
    $('#extend_box').css('height',_h);
    $('#extend_box .panel-body').empty().css('height',_h-280);
    $('#extend_box .panel-footer').empty();
    $('#extend_box .panel-heading b').empty();
    switch(obj){
        case 1:
            $('#extend_box .panel-heading b').html("交班记录");
        $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'getcounternoprintrecord'))}",{},function(data){
            //alert(data);
            var feedback=eval("("+data+")");
            var record=feedback.item;
            var temp='<table class="table table-hover text-center"><thead><tr><th>接班时间</th><th>交班时间</th><th>收银员</th><th>总金额</th><th onclick=print()>实际营收</th><th>操作</th></tr></thead><tbody>';
            for(i in record){
                temp+='<tr><td scope="row">'+record[i]['starttime']+'</td>';
                temp+='<td scope="row">'+record[i]['endtime']+'</td>';
                temp+='<td scope="row">'+record[i]['realname']['realname']+'</td>';
		console.log(record[i]['realname']);
                temp+='<td scope="row">'+record[i]['totalprice']+'</td>';
                temp+='<td scope="row">'+record[i]['revenue']+'</td>';
                <!--temp+='<td scope="row">'+record[i]['createtime']+'</td>';-->
		temp+='<td scope="row"><a href="index.php?i={$_W['uniacid']}&c=entry&starttime=';
		temp+= record[i]['starttime2'];
		temp+= '&endtime='
		temp+= record[i]['endtime2'];
		temp+='&do=printrijie&m=j_money" class="btn btn-success">明细</a></td>';

                // temp+='<td  scope="row">'+record[i]['totalprice']+'</td><td  scope="row">'+record[i]['revenue']+'</td><td  scope="row">'+record[i]['createtime']+'</td><td>';
                // if(parseInt(record[i]['status'])){
                //     temp+=parseInt(record[i]['isprint']) ? '':'<a href="javascript:reprint(\''+record[i]["out_trade_no"]+'\',1)"><i class="fa fa-print"></i></a>';
                // }
                temp+='</tr>';
            }
            temp+='</tbody></table>';
            $("#extend_box .panel-body").append(temp);
            // $("#extend_box .panel-footer").html("交班记录共 <b>"+feedback.num+"</b>条");
        });
        break;
        case 2:
            $('#extend_box .panel-heading b').html("收款成功记录");
        var temp='<iframe src="{php echo $this->createMobileUrl("counthistory")}" id="historybox" name="historybox" style="width:98%;"></iframe>';
        $("#extend_box .panel-body").append(temp);
        //$("#extend_box .panel-footer").append('<a href="javascript:resetHeight(\'historybox\')" class="btn btn-info">更新</a>');
        $("#extend_box .panel-body").height();
        break;
        // 添加排号管理、预定管理2016.10.26
        case 3:
            $('#extend_box .panel-heading b').html("排号管理");
        var temp='<iframe src="{php echo $this->createMobileUrl("queueorder2")}" id="historybox" name="historybox" style="width:100%;height:470px"></iframe>';
        $("#extend_box .panel-body").append(temp);
        $("#extend_box .panel-body").height();
        break;
        case 4:
            $('#extend_box .panel-heading b').html("预定管理");
        var temp='<iframe src="{php echo $this->createMobileUrl("reservation")}" id="historybox" name="historybox" style="width:100%;height:470px"></iframe>';
        $("#extend_box .panel-body").append(temp);
        $("#extend_box .panel-body").height();
        break;
    }
    $('#extend_box').show();
}
function resetHeight(obj){
    var _h=$("#"+obj).contents().find("body").height();
    $("#"+obj).height(_h);
}
//----------扩展专用-----------//
function extendPay(osn,fee,callback,printid){
    isPaying=false;
    if(printid)printDoc=printid;
    var temp=parseFloat(fee);
    if(temp*100==0){
        swal("请输入金额");
        return;
    }
    console.log("支付开始");
    swal({
        title: "刷卡支付", 
        text: "收款金额为<span style='color:#F00'>￥"+temp+"元</span>",   
        type: "input",
        html:true,
        showLoaderOnConfirm: true,
        showCancelButton: true,   
        closeOnConfirm: false,
        confirmButtonText: "确认收款",
        cancelButtonText: "关闭",  
        inputPlaceholder: "请扫描客户的付款二维码" 
    }, function(inputValue){
        if (inputValue === false) return false;      
        if (inputValue === "") {
            swal.showInputError("请扫描客户的付款二维码");     
            return false
        }
        if(isPaying)return;
        isPaying=true;
        swal({title:"请稍后",showConfirmButton:false });
        if(inputValue.substr(0,1)=="1"){
            console.log("客户使用【微信】支付");
            $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'paywechat'))}",{"qrcode":inputValue,"userid":"{$user['id']}","fee":temp,"old_trade_no":osn},function(data){
                isPaying=false;
                var feedback=eval("("+data+")");
                if(feedback.success){
                    var _item=feedback.items;
                    $("#tradeno").val(_item['out_trade_no']);
                    if(_item['result_code']=="SUCCESS"){
                        extendPaySuccess(callback);
                    }else{
                        if(_item['err_code']=="USERPAYING"){
                            setTimeout(function(){extendCheckpay(_item['out_trade_no'])},5000);
                            swal({
                                title: "温馨提示",   
                                text: "等待客户输入支付密码",
                                confirmButtonText: "关闭订单",
                            }, function(isConfirm){
                                if (isConfirm) {
                                    deleteOrder(_item['out_trade_no']);
                                }
                            }
                                );
                        }
                    }
                }else{
                    swal(feedback.msg);
                    return;
                }
            })
        }else{
            console.log("客户使用【支付宝】支付");
            $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'payalipay'))}",{"qrcode":inputValue,"userid":"{$user['id']}","fee":temp,"old_trade_no":osn},function(data){
                var feedback=eval("("+data+")");
                if(feedback.success){
                    if(feedback.result){
                        $("#tradeno").val(feedback.out_trade_no);
                        checkTimeout=setTimeout(function(){extendCheckAlipay(callback)},5000);
                        swal({
                            title: "温馨提示",   
                            text: "等待客户输入支付密码",
                            confirmButtonText: "关闭订单",
                        }, function(isConfirm){
                            if (isConfirm) {
                                clearTimeout(checkTimeout);
                            }
                        }
                            );
                    }else{
                        var _item=feedback.items;
                        $("#tradeno").val(_item['out_trade_no']);
                        extendPaySuccess(callback);
                    }
                }else{
                    swal(feedback.msg);
                    return;
                }
            })
        }
    });
}
function extendCheckpay(callback){
    var temporder=$("#tradeno").val();
    if(!temporder){
        swal("订单号不能为空");
        return;
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'checwechatkpay'))}",{"orderid":temporder},function(data){
        var feedback=eval("("+data+")");
        if(feedback.success){
            var temp=feedback.items;
            if(temp['trade_state']=="SUCCESS"){
                extendPaySuccess(callback);
            }else if(temp['trade_state']=="NOTPAY"){
                swal("用户自动取消支付");
            }else if(temp['trade_state']=="USERPAYING"){
                setTimeout(function(){extendCheckpay(callback)},5000);
            }else{
                swal("支付失败，未知错误!");
            }
        }else{
            swal(feedback.msg);
        }
    });
}

function extendCheckAlipay(callback){
    var temporder=$("#tradeno").val();
    if(!temporder){
        swal("订单号不能为空");
        return;
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'checkalipay'))}",{"orderid":temporder},function(data){
        var feedback=eval("("+data+")");
        if(feedback.success){
            if(feedback.result){
                checkTimeout=setTimeout(function(){checkAlipay(callback)},5000);
                swal({
                    title: "温馨提示",   
                    text: "等待客户输入支付密码",
                    confirmButtonText: "关闭订单",
                }, function(isConfirm){
                    if (isConfirm) {
                        clearTimeout(checkTimeout);
                    }
                }
                    );
            }else{
                extendPaySuccess(callback);
            }
        }else{
            swal(feedback.msg);
        }
    });
}
//支付成功；
function extendPaySuccess(callback){
    var temporder=$("#tradeno").val();
    if(!temporder){swal("订单号不能为空");return;}
    $("#tradeno").val("");
    $("#fee").val(0);
    var printNum=parseInt("{$cfg['printnum']}") ? parseInt("{$cfg['printnum']}") :0;
    if(printNum>1){
        swal({title:"收款成功"});
    }else{
        swal({title:"收款成功",timer:3000});
    }
    if(undefined!=callback)callback(old_orderid);
    if(printDoc && temporder && printNum){
        $("#printbox").attr("src","{php echo $this->createMobileUrl('printer')}&id="+printDoc+"&tradeid="+temporder);
        if(printNum>1){
            swal({
                title: "再打一张小票？",   
                showCancelButton: true,
                cancelButtonText: "取消",
                confirmButtonText: "打印",
            }, function(isConfirm){
                if (isConfirm) {
                    $("#printbox").attr("src","{php echo $this->createMobileUrl('printer')}&id="+printDoc+"&tradeid="+temporder);
                }
            }
                );
        }
    }
    $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'marketing'))}",{"orderid":temporder},function(data){
        console.log(data);
        $.post("{php echo $this->createMobileUrl('ajax',array('op'=>'tempmsg'))}",{"orderid":temporder},function(data2){
            console.log(data2);
        });
    });
    getCounterRecord();
}
</script>

{loop $btnlist $row}
{if $row['jsurl']}
<!--
{$row['btnname']}--{$row['btnurl']}
-->
<script src="../attachment/j_money/js/{php echo $_W['uniacid']}/{$row['jsurl']}"></script>
{/if}
{/loop}
{/if} 
